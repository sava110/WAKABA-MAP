<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="styles.css">
  <title>蔵書検索 - あんふlibrary</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }

    h2 {
      text-align: center;
    }

    #searchContainer {
      text-align: center;
      margin-bottom: 20px;
    }

    #booksContainer {
      text-align: left;
    }

    #booksList {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 20px;
      justify-content: center;
    }

    .book {
      padding: 10px;
      border: 1px solid #ccc;
      box-shadow: 2px 2px 12px rgba(0, 0, 0, 0.1);
      cursor: pointer;
    }

    .book img {
      display: block;
      margin: 0 auto 10px;
      max-width: 100%;
    }

    @media (min-width: 600px) {
      #booksList {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (min-width: 900px) {
      #booksList {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (min-width: 1200px) {
      #booksList {
        grid-template-columns: repeat(4, 1fr);
      }
    }
  </style>
</head>
<body>
  <h2>蔵書検索</h2>
  <button id="allMode">本一覧を見る</button>
  <button id="titleMode">図書名で検索</button>
  <button id="authorMode">著者名で検索</button>
  <button id="tagsMode">タグで検索</button>

  <div id="searchContainer" style="display:none;">
    <div id="searchTitleContainer" style="display:none;">
      <label for="searchTitle">図書名：</label>
      <input id="searchTitle" type="text"><br>
    </div>
    <div id="searchAuthorContainer" style="display:none;">
      <label for="searchAuthor">著者名：</label>
      <input id="searchAuthor" type="text"><br>
    </div>
    <div id="searchTagsContainer" style="display:none;">
      <label for="searchTags">タグ：</label>
      <input id="searchTags" type="text"><br>
    </div>
    <button id="searchBtn">検索</button>
  </div>

  <div id="booksContainer">
    <div id="booksList"></div>
    <button id="loadMoreBtn" style="display:none;">もっと見る</button>
  </div>

  <script>
    let currentPage = 1;
    let currentMode = ''; // 現在の検索モード

    let uname = '';

    window.onload = function() {
      const params = new URLSearchParams(window.location.search);
      uname = params.get('username');
    }

    const fetchBooks = (page = 1, searchParams = {}, mode = 'all') => {
      let url = `api/query/search/${mode}`;
      const params = new URLSearchParams({ page });

      if (mode === 'title' && searchParams.title) {
        params.append('title', searchParams.title);
      } else if (mode === 'author' && searchParams.author) {
        params.append('author', searchParams.author);
      } else if (mode === 'tags' && searchParams.tags) {
        params.append('tags', searchParams.tags);
      }

      fetch(`${url}?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
          const booksList = document.getElementById('booksList');
          if (page === 1) booksList.innerHTML = ''; // 1ページ目ならリセット
          data.books.forEach(book => {
            const bookDiv = document.createElement('div');
            bookDiv.classList.add('book');
            bookDiv.addEventListener('click', () => {
              window.location.href = `book_detail.html?id=${book.id}&username=${encodeURIComponent(uname)}`;
            });

            const rent_num = Number(book.rent_status);
            const rentStatus = rent_num === 0 ? '利用可能' : '貸出中';
            const imageElement = book.image ? `<img src="${book.image}" alt="${book.title}" width="100">` : '';
            const count_num = Number(book.waiting_count)
            const waitingCount = count_num ? ` ${book.waiting_count}人` : '0人';
            const tags = book.tags.join(', ');
            bookDiv.innerHTML = `
              <div id="imagePlaceholder">
              ${imageElement}
            </div>
              <strong>図書名:</strong> ${book.title}<br>
              <strong>著者名:</strong> ${book.author}<br>
              <strong>タグ:</strong> ${tags}<br>
              <strong>貸主名:</strong> ${book.owner}<br>
              <strong>貸出状態:</strong> ${rentStatus}<br>
              <strong>待機人数:</strong> ${waitingCount}<strong></strong>
            `;
            booksList.appendChild(bookDiv);
          });
          document.getElementById('loadMoreBtn').style.display = data.hasMore ? 'block' : 'none';
        })
        .catch(error => console.error('Error:', error));
    };

    const clearSearchInputs = () => {
      document.getElementById('searchTitle').value = '';
      document.getElementById('searchAuthor').value = '';
      document.getElementById('searchTags').value = '';
    };

    document.getElementById('allMode').addEventListener('click', () => {
      currentMode = 'all';
      currentPage = 1;
      clearSearchInputs();
      document.getElementById('searchTitleContainer').style.display = 'none';
      document.getElementById('searchAuthorContainer').style.display = 'none';
      document.getElementById('searchTagsContainer').style.display = 'none';
      document.getElementById('searchContainer').style.display = 'none';
      document.getElementById('booksList').innerHTML = '';
fetchBooks(currentPage, currentMode)
    });
    
    document.getElementById('titleMode').addEventListener('click', () => {
      currentMode = 'title';
      currentPage = 1;
      clearSearchInputs();
      document.getElementById('searchTitleContainer').style.display = 'block';
      document.getElementById('searchAuthorContainer').style.display = 'none';
      document.getElementById('searchTagsContainer').style.display = 'none';
      document.getElementById('searchContainer').style.display = 'block';
      document.getElementById('booksList').innerHTML = '';
    });

    document.getElementById('authorMode').addEventListener('click', () => {
      currentMode = 'author';
      currentPage = 1;
      clearSearchInputs();
      document.getElementById('searchTitleContainer').style.display = 'none';
      document.getElementById('searchAuthorContainer').style.display = 'block';
      document.getElementById('searchTagsContainer').style.display = 'none';
      document.getElementById('searchContainer').style.display = 'block';
      document.getElementById('booksList').innerHTML = '';
    });

    document.getElementById('tagsMode').addEventListener('click', () => {
      currentMode = 'tags';
      currentPage = 1;
      clearSearchInputs();
      document.getElementById('searchTitleContainer').style.display = 'none';
      document.getElementById('searchAuthorContainer').style.display = 'none';
      document.getElementById('searchTagsContainer').style.display = 'block';
      document.getElementById('searchContainer').style.display = 'block';
      document.getElementById('booksList').innerHTML = '';
    });

    document.getElementById('searchBtn').addEventListener('click', () => {
      const title = document.getElementById('searchTitle').value;
      const author = document.getElementById('searchAuthor').value;
      const tags = document.getElementById('searchTags').value;
      currentPage = 1;
      fetchBooks(currentPage, { title, author, tags }, currentMode);
    });

    document.getElementById('loadMoreBtn').addEventListener('click', () => {
      currentPage++;
      if (currentMode === 'title') {
        const title = document.getElementById('searchTitle').value;
        fetchBooks(currentPage, { title }, currentMode);
      } else if (currentMode === 'author') {
        const author = document.getElementById('searchAuthor').value;
        fetchBooks(currentPage, { author }, currentMode);
      } else if (currentMode === 'tags') {
        const tags = document.getElementById('searchTags').value;
        fetchBooks(currentPage, { tags }, currentMode);
      } else {
        fetchBooks(currentPage);
      }
    });

    // ページ読み込み時にすべての蔵書を取得
    fetchBooks(currentPage);
  </script>
<footer>
  2024 hina
</footer>
</body>
</html>
